# Green Moment Backend API

Backend API service for the Green Moment carbon tracking application.

## Overview

This API provides:
- User authentication (Google OAuth + Anonymous)
- Carbon intensity data and forecasting
- Chore logging and carbon savings calculation
- Gamification features (leagues, tasks, points)
- Monthly carbon reduction reports

## Tech Stack

- **Framework**: FastAPI
- **Database**: PostgreSQL with SQLAlchemy ORM
- **Cache**: Redis
- **Authentication**: JWT + Google OAuth 2.0
- **Background Tasks**: Celery
- **Container**: Docker

## Project Structure

```
green_moment_backend_api/
├── app/
│   ├── api/           # API endpoints
│   ├── core/          # Core functionality (config, security, database)
│   ├── models/        # SQLAlchemy models
│   ├── schemas/       # Pydantic schemas
│   ├── services/      # Business logic
│   └── utils/         # Utility functions
├── migrations/        # Alembic database migrations
├── tests/            # Test suite
├── config/           # Configuration files
└── requirements.txt  # Python dependencies
```

## Setup

1. **Create virtual environment**:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # or
   venv\Scripts\activate  # Windows
   ```

2. **Install dependencies**:
   ```bash
   pip install -r requirements.txt
   ```

3. **Set up environment variables**:
   ```bash
   cp .env.example .env
   # Edit .env with your configuration
   ```

4. **Set up PostgreSQL database**:
   ```bash
   createdb green_moment
   ```

5. **Run database migrations**:
   ```bash
   alembic upgrade head
   ```

6. **Start Redis**:
   ```bash
   redis-server
   ```

7. **Run the development server**:
   ```bash
   uvicorn app.main:app --reload
   ```

## API Documentation

Once running, visit:
- Swagger UI: http://localhost:8000/api/v1/docs
- ReDoc: http://localhost:8000/api/v1/redoc

## Key Features

### Authentication
- Google OAuth 2.0 for account creation
- Anonymous mode with local-only data
- JWT tokens for API access

### Carbon Calculations
- Real-time estimation when logging chores
- Historical calculation on 1st of each month
- Comparison with peak carbon intensity periods

### Gamification
- 5 league levels based on carbon savings
- Monthly tasks (3 required)
- Points system for achievements

## Environment Variables

See `.env.example` for required configuration:
- Database connection
- Redis connection
- Google OAuth credentials
- Secret keys
- Carbon data integration path

## Development

### Running tests:
```bash
pytest
```

### Code formatting:
```bash
black app/
```

### Linting:
```bash
flake8 app/
```

## Integration with Data Collection

The API reads carbon intensity data from CSV files generated by the data collection pipeline at:
`/home/bill/StudioProjects/green_moment_integrated/stru_data/`

Data is cached in Redis and refreshed every 10 minutes.